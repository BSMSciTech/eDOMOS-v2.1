{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!--
Your current dashboard.html already implements most of what you need for the client-side web app:

- Status Cards: Show door status, alarm status, timer setting, last event.
- Event Statistics: Show total events, door open, alarms.
- Recent Events: Real-time event log (populated by JavaScript).
- Controls Modal: For setting timer and backing up the database.
- Real-time Updates: Uses JavaScript to fetch and update events, and can be extended to use WebSocket for instant updates.

How it works for your requirements:
- The HTML file is stored on the server (Raspberry Pi) and is accessible from any client PC via a browser.
- All event data is stored in the server-side SQLite database.
- The dashboard displays all required real-time status and statistics.

If you want true real-time updates (no refresh needed):
- You already have a socket.js file that listens for WebSocket events (`new_event`) and updates the event log instantly.
- Make sure this JS file is included in your base.html or dashboard.html.

You do NOT need to change the HTML for the requirements you listed.
If you want to further enhance the real-time experience (e.g., update the status/statistics cards instantly), let me know and I can help you add that JavaScript logic.
-->

<div class="row">
    <!-- System Status Cards -->
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-door-open me-2"></i>Door Status</h5>
                <p class="card-text display-6">{{ door_status }}</p>
                <div class="mt-3">
                    <span class="badge bg-{{ 'success' if door_status == 'Closed' else 'danger' }}">
                        {{ 'Closed' if door_status == 'Closed' else 'Open' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-warning h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-bell me-2"></i>Alarm Status</h5>
                <p class="card-text display-6">{{ alarm_status }}</p>
                <div class="mt-3">
                    <span class="badge bg-{{ 'success' if alarm_status == 'Inactive' else 'danger' }}">
                        {{ 'Inactive' if alarm_status == 'Inactive' else 'Active' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-info h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-clock me-2"></i>Timer Setting</h5>
                <p class="card-text display-6">{{ timer_set }} sec</p>
                <div class="mt-3">
                    <span class="badge bg-light text-dark">Current Setting</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-history me-2"></i>Last Event</h5>
                {% if last_event %}
                <p class="card-text">{{ last_event.event_type.replace('_', ' ').title() }}</p>
                <small>{{ last_event.timestamp }}</small>
                {% else %}
                <p class="card-text">No events yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Controls Section: Always Visible -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-sliders-h me-2"></i>System Controls
            </div>
            <div class="card-body">
                <form id="controls-form" onsubmit="return false;">
                    <div class="alert alert-info" style="font-size: 1rem;">
                        <b>Controls:</b><br>
                        <b>Set Time:</b> Set the alarm timer (how long after the door opens the alarm should trigger).<br>
                        <b>Backup Database:</b> Download a copy of the database file to your PC instantly.<br>
                        <b>Auto Backup Database:</b> Set an interval (in minutes) for automatic database backup. The database file will be automatically downloaded to your PC at the specified interval.
                    </div>
                    <div class="mb-3">
                        <label for="timer-duration" class="form-label">Alarm Timer (seconds)</label>
                        <input type="number" class="form-control" id="timer-duration" value="{{ timer_set }}" min="10" max="300">
                        <div class="form-text">Time after door opens before alarm triggers</div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="save-settings">Save Settings</button>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-success" id="backup-db">Backup Database</button>
                    </div>
                    <div class="mb-3">
                        <label for="auto-backup-interval" class="form-label">Auto Backup Interval (minutes)</label>
                        <input type="number" class="form-control" id="auto-backup-interval" value="" min="1" max="1440">
                        <div class="form-text">Set interval for automatic database backup to your PC</div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="set-auto-backup">Set Auto Backup</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Event Statistics -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Event Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="display-6 text-primary" id="stat-total-events">{{ total_events }}</div>
                        <small>Total Events</small>
                    </div>
                    <div class="col-3">
                        <div class="display-6 text-success" id="stat-door-open">{{ door_open_events }}</div>
                        <small>Door Open</small>
                    </div>
                    <div class="col-3">
                        <div class="display-6 text-info" id="stat-door-close">{{ door_close_events }}</div>
                        <small>Door Close</small>
                    </div>
                    <div class="col-3">
                        <div class="display-6 text-danger" id="stat-alarms">{{ alarm_events }}</div>
                        <small>Alarms</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Event Log -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Recent Events</h5>
                <button class="btn btn-sm btn-outline-primary" id="view-all-logs">View All</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="recent-events-table">
                        <thead>
                            <tr>
                                <th scope="col">Timestamp</th>
                                <th scope="col">Event Type</th>
                                <th scope="col">Description</th>
                            </tr>
                        </thead>
                        <tbody id="recent-events">
                            <!-- Events will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Controls Modal -->
<div class="modal fade" id="controlsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-sliders-h me-2"></i>System Controls</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Modal content removed as controls are now always visible -->
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
{% include 'report_modal.html' %}

<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
    // Tab navigation
    const permissionsElem = document.getElementById('permissions-data');
    let permissions = [];
    if (permissionsElem) {
        try {
            permissions = JSON.parse(permissionsElem.textContent);
        } catch (e) {
            permissions = [];
        }
    }
    
    if (permissions.includes('controls')) {
        document.getElementById('controls-tab')?.addEventListener('click', function(e) {
            e.preventDefault();
            new bootstrap.Modal(document.getElementById('controlsModal')).show();
        });
    }
    
    if (permissions.includes('event_log')) {
        document.getElementById('event-log-tab')?.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '/event-log';
        });
    }
    
    if (permissions.includes('report')) {
        document.getElementById('report-tab')?.addEventListener('click', function(e) {
            e.preventDefault();
            new bootstrap.Modal(document.getElementById('reportModal')).show();
        });
    }
    
    if (permissions.includes('analytics')) {
        document.getElementById('analytics-tab')?.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '/analytics';
        });
    }
    
    document.getElementById('view-all-logs')?.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/event-log';
    });
    
    // Save settings
    document.getElementById('save-settings')?.addEventListener('click', function(e) {
        e.preventDefault();
        const duration = document.getElementById('timer-duration').value;
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timer_duration: parseInt(duration) })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // Update the timer setting card instantly
                const timerCard = document.querySelector('.card-title i.fa-clock')?.closest('.card-body').querySelector('.display-6');
                if (timerCard) timerCard.textContent = duration + ' sec';
                // Update the 'Current Setting' badge as well
                const badge = document.querySelector('.card-title i.fa-clock')?.closest('.card-body').querySelector('.badge');
                if (badge) badge.textContent = 'Current Setting: ' + duration + ' sec';
                alert('Settings saved successfully!');
            } else {
                alert('Error saving settings: ' + data.error);
            }
        });
    });
    
    // Backup database
    document.getElementById('backup-db')?.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/api/backup';
    });
    
    // Auto Backup logic
    let autoBackupTimer = null;
    document.getElementById('set-auto-backup')?.addEventListener('click', function(e) {
        e.preventDefault();
        const intervalMin = parseInt(document.getElementById('auto-backup-interval').value);
        if (isNaN(intervalMin) || intervalMin < 1) {
            alert('Please enter a valid interval (minutes)');
            return;
        }
        if (autoBackupTimer) clearInterval(autoBackupTimer);
        autoBackupTimer = setInterval(() => {
            // Create a hidden link and trigger download
            const link = document.createElement('a');
            link.href = '/api/backup';
            link.download = 'alarm_system_backup.db';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, intervalMin * 60 * 1000);
        alert('Auto backup started. The database will be downloaded every ' + intervalMin + ' minutes.');
    });
});
</script>
{% endblock %}